ТипДокументаЗаказа      = "ДокументСсылка.ЗаказКлиента";
ТипДокументаРеализации     = "ДокументСсылка.РеализацияТоваровУслуг"; 
ТипДокументаКорректировкиРеализации = "ДокументСсылка.КорректировкаРеализации";
ТипДокументаСчетФактуры = "ДокументСсылка.СчетФактураВыданный";
 
ИмяОрганизации          = "Организация";
ИмяКонтрагента          = "Контрагент";
ИмяТочкиДоставки        = "Партнер";
ИмяДатаОтгрузки         = "ЖелаемаяДатаОтгрузки";
ДатаЗаказа1С            = "ДатаПоДаннымКлиента";
НомерЗаказа1С           = "НомерПоДаннымКлиента";
НомерВходящегоДокумента = "НомерВходящегоДокумента";
ДатаВходящегоДокумента  = "ДатаВходящегоДокумента";
ИмяЗаказа1С             = "ЗаказКлиента";
 
// Заказ клиента.
Если ТипЗнч(Источник.Ссылка) = Тип(ТипДокументаЗаказа) Тогда
 
    ВыборкаУчастниковВЭДО = КонтрагентУчаствуетВЭДО(Источник[ИмяОрганизации], Источник[ИмяКонтрагента]);
    Если НЕ ВыборкаУчастниковВЭДО.Количество() = 0 Тогда
 
        НаборЗаписей = РегистрыСведений.ЭКОМ_ЦепочкиДокументовПоставщика.СоздатьНаборЗаписей();
        НаборЗаписей.Отбор.ORDERDATE.Установить(Источник.ДатаПоДаннымКлиента);
        НаборЗаписей.Отбор.Организация.Установить(Источник.Организация);
        НаборЗаписей.Отбор.Контрагент.Установить(Источник.Контрагент);
        НаборЗаписей.Отбор.ТочкаДоставки.Установить(Источник.Партнер);
        НаборЗаписей.Отбор.ORDERNUMBER.Установить(Источник.НомерПоДаннымКлиента);
 
        ДанныеИзмерений = Новый Структура;
        ДанныеИзмерений.Вставить("Заказ",            Источник.Ссылка);
        ДанныеИзмерений.Вставить("Организация",        Источник[ИмяОрганизации]);
        ДанныеИзмерений.Вставить("Контрагент",        Источник[ИмяКонтрагента]);
        ДанныеИзмерений.Вставить("ТочкаДоставки",    Источник[ИмяТочкиДоставки]);
 
        ДанныеРесурсов = Новый Структура;
        ДанныеРесурсов.Вставить("ДатаПоставки",     Источник[ИмяДатаОтгрузки]);
        ДанныеРесурсов.Вставить("КоличествоЗаказ",    Источник.Товары.Итог("Количество"));
        ДанныеРесурсов.Вставить("СуммаЗаказ",        Источник.Товары.Итог("Сумма"));
 
        // Выполним блокировку данных.
        ЭКОМ_ПодпискаСобытий.ВыполнитьБлокировкуНабораЗаписей(НаборЗаписей.Отбор, "ЭКОМ_ЦепочкиДокументовПоставщика");            
 
        НаборЗаписей.Прочитать();
        Если НаборЗаписей.Количество() = 0 Тогда
            // Записываем документ в первый раз.
            ЭКОМ_ПодпискаСобытий.СформироватьЗаписьВРегистр(НаборЗаписей.Добавить(), ДанныеИзмерений, ДанныеРесурсов); // записываем данные в регистр если они заполнены
        Иначе
 
            // Если существует документ в регистре.
            Для Каждого НоваяЗапись Из НаборЗаписей Цикл
                ЭКОМ_ПодпискаСобытий.СформироватьЗаписьВРегистр(НоваяЗапись, ДанныеИзмерений, ДанныеРесурсов); // записываем данные в регистр если они заполнены                    
            КонецЦикла;
 
        КонецЕсли;        
 
        Если НаборЗаписей.Модифицированность() Тогда
            НаборЗаписей.Записать();
        КонецЕсли;
 
        // Изменение количества принятого в Эком документе по данным заказа клиента.
        Для Каждого НоваяЗапись Из НаборЗаписей Цикл
            Если НЕ НоваяЗапись.ORDER.Пустая() Тогда
                ЭкомДокументОбъект = НоваяЗапись.ORDER.ПолучитьОбъект();
				Если НЕ ЭкомДокументОбъект.Заблокирован() Тогда
					Для Каждого Строка Из Источник.Товары Цикл
	                    СтрокаТоваров = ЭкомДокументОбъект.ТЧ_Товары.Найти(Строка.Номенклатура, "Номенклатура");
	                    Если НЕ СтрокаТоваров = Неопределено
	                        И НЕ СтрокаТоваров.КоличествоПоставляемое = Строка.Количество Тогда
	                        СтрокаТоваров.КоличествоПоставляемое = Строка.Количество;
	                    КонецЕсли;
	                КонецЦикла;
	                Если ЭкомДокументОбъект.Модифицированность() Тогда
	                    Попытка
	                        ЭкомДокументОбъект.Записать();
	                    Исключение КонецПопытки;
					КонецЕсли;
				КонецЕсли;
            КонецЕсли;
        КонецЦикла;
 
    КонецЕсли;        
 
КонецЕсли;   
 
// Реализация.
Если ТипЗнч(Источник.Ссылка) = Тип(ТипДокументаРеализации) Тогда
 
    ВыборкаУчастниковВЭДО = КонтрагентУчаствуетВЭДО(Источник[ИмяОрганизации], Источник[ИмяКонтрагента]);
    Если НЕ ВыборкаУчастниковВЭДО.Количество() = 0 Тогда
 
        Если ЗначениеЗаполнено(Источник[ИмяЗаказа1С]) Тогда // Реализация была создана на основании заказа
            ДокументЗаказа = Источник[ИмяЗаказа1С];
        Иначе // Реализация создавалась на основании ORDER
            ДокументЗаказа = Источник.Ссылка;
        КонецЕсли;
        // Поиск ЭКОМ документа.
        Запрос = Новый Запрос;
        Запрос.Текст =     "ВЫБРАТЬ
                           |    ЭКОМ_Документы.Ссылка КАК ORDER
                           |ПОМЕСТИТЬ вт
                           |ИЗ
                           |    Документ.ЭКОМ_Документы КАК ЭКОМ_Документы
                           |ГДЕ
                           |    ЭКОМ_Документы.Документ1С = &Источник
                           |;
                           |
                           |////////////////////////////////////////////////////////////////////////////////
                           |ВЫБРАТЬ
                           |    вт.ORDER КАК ORDER
                           |ИЗ
                           |    вт КАК вт
                           |ГДЕ
                           |    вт.ORDER.ВидДокумента = ЗНАЧЕНИЕ(Перечисление.ЭКОМ_ВидыДокументов.ORDER_Входящий)";
 
        Запрос.УстановитьПараметр("Источник", ДокументЗаказа);
 
        РезультатЗапроса = Запрос.Выполнить();
 
        ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
 
        Если ВыборкаДетальныеЗаписи.Следующий() Тогда
 
            НаборЗаписей = РегистрыСведений.ЭКОМ_ЦепочкиДокументовПоставщика.СоздатьНаборЗаписей();
            НаборЗаписей.Отбор.ORDER.Установить(ВыборкаДетальныеЗаписи.ORDER);
 
            // Выполним блокировку данных.
            ЭКОМ_ПодпискаСобытий.ВыполнитьБлокировкуНабораЗаписей(НаборЗаписей.Отбор, "ЭКОМ_ЦепочкиДокументовПоставщика");
 
            НаборЗаписей.Прочитать();
 
            ЭкомДокументы = Новый Массив;
 
            Если НЕ НаборЗаписей.Количество() = 0 Тогда
 
                ДанныеИзмерений = Новый Структура;
                ДанныеИзмерений.Вставить("Накладная",        Источник.Ссылка);
                ДанныеИзмерений.Вставить("Организация",     Источник[ИмяОрганизации]);
                ДанныеИзмерений.Вставить("Контрагент",        Источник[ИмяКонтрагента]);
                ДанныеИзмерений.Вставить("ТочкаДоставки",    Источник[ИмяТочкиДоставки]);
 
                ДанныеРесурсов = Новый Структура;
                ДанныеРесурсов.Вставить("КоличествоНакладная",     Источник.Товары.Итог("Количество"));
                ДанныеРесурсов.Вставить("СуммаНакладная",        Источник.Товары.Итог("Сумма"));
                ДанныеРесурсов.Вставить("СуммаНДСНакладная",    Источник.Товары.Итог("СуммаНДС"));
 
                // Если существует документ в регистре.
 
                Для Каждого НоваяЗапись Из НаборЗаписей Цикл
                    ЭКОМ_ПодпискаСобытий.СформироватьЗаписьВРегистр(НоваяЗапись, ДанныеИзмерений, ДанныеРесурсов);
                    Если ЭкомДокументы.Найти(НоваяЗапись.ORDER) = Неопределено Тогда
                        ЭкомДокументы.Добавить(НоваяЗапись.ORDER);
                    КонецЕсли;
                КонецЦикла;
                Если НаборЗаписей.Модифицированность() Тогда
                    НаборЗаписей.Записать();
                КонецЕсли;
 
                // Меняем количество в Эком документе.
                Для Каждого ЭкомДокумент Из ЭкомДокументы Цикл
                    ЭкомДокументОбъект = ЭкомДокумент.ПолучитьОбъект();
                    Для Каждого Строка Из Источник.Товары Цикл
                        СтрокаТоваров = ЭкомДокументОбъект.ТЧ_Товары.Найти(Строка.Номенклатура, "Номенклатура");
                        Если НЕ СтрокаТоваров = Неопределено
                            И НЕ СтрокаТоваров.КоличествоПринятое = Строка.Количество Тогда
                            СтрокаТоваров.КоличествоПринятое = Строка.Количество;
                        КонецЕсли;
                    КонецЦикла;
                    Если ЭкомДокументОбъект.Модифицированность() Тогда
                        Попытка
                            ЭкомДокументОбъект.Записать();
                        Исключение КонецПопытки;
                    КонецЕсли;
                КонецЦикла;
 
            КонецЕсли;
 
        КонецЕсли;
 
    КонецЕсли;        
 
КонецЕсли;
 
// Корректировка реализации.
Если ТипЗнч(Источник.Ссылка) = Тип(ТипДокументаКорректировкиРеализации) Тогда
 
    ВыборкаУчастниковВЭДО = КонтрагентУчаствуетВЭДО(Источник[ИмяОрганизации], Источник[ИмяКонтрагента]);
    Если НЕ ВыборкаУчастниковВЭДО.Количество() = 0
        И ТипЗнч(Источник.ДокументОснование) = Тип("ДокументСсылка.РеализацияТоваровУслуг") Тогда
 
        НаборЗаписей = РегистрыСведений.ЭКОМ_ЦепочкиДокументовПоставщика.СоздатьНаборЗаписей();
        НаборЗаписей.Отбор.Накладная.Установить(Источник.ДокументОснование);
 
        // Выполним блокировку данных.
        ЭКОМ_ПодпискаСобытий.ВыполнитьБлокировкуНабораЗаписей(НаборЗаписей.Отбор, "ЭКОМ_ЦепочкиДокументовПоставщика");
 
        НаборЗаписей.Прочитать();
 
        Если НЕ НаборЗаписей.Количество() = 0 Тогда
 
            ДанныеИзмерений = Новый Структура;
            ДанныеИзмерений.Вставить("Накладная_Кор", Источник.Ссылка);
 
            ДанныеРесурсов = Новый Структура;
            ДанныеРесурсов.Вставить("КоличествоНакладная_Кор",    Источник.Товары.Итог("Количество"));
            ДанныеРесурсов.Вставить("СуммаНакладная_Кор",        Источник.Товары.Итог("Сумма"));
            ДанныеРесурсов.Вставить("СуммаНДСНакладная_Кор",    Источник.Товары.Итог("СуммаНДС"));
 
            // Если существует документ в регистре.
 
            Для Каждого НоваяЗапись Из НаборЗаписей Цикл
                ЭКОМ_ПодпискаСобытий.СформироватьЗаписьВРегистр(НоваяЗапись, ДанныеИзмерений, ДанныеРесурсов);
            КонецЦикла;
 
            Если НаборЗаписей.Модифицированность() Тогда
                НаборЗаписей.Записать();
            КонецЕсли;
 
        КонецЕсли;
 
    КонецЕсли;
 
КонецЕсли;
 
//// СчетФактураВыданный
//Если ТипЗнч(Источник.Ссылка) = Тип(ТипДокументаСчетФактуры) Тогда
 
//    ДанныеИзмерений = Новый Структура;
//    ДанныеИзмерений.Вставить("СЧФ", Источник.Ссылка);
 
//    ДанныеРесурсов = Новый Структура;
//    ДанныеРесурсов.Вставить("СуммаСЧФ" , Источник.ДокументыОснования.Итог("Сумма"));
 
//    Для каждого СтрокаДокументОснование Из Источник.ДокументыОснования Цикл
//        Если ТипЗнч(СтрокаДокументОснование.ДокументОснование) = Тип(ТипДокументаРеализации) Тогда
 
//            ДокументРеализации = СтрокаДокументОснование.ДокументОснование;
//            ДокументЗаказа      = ДокументРеализации[ИмяЗаказа1С];
 
//            ДанныеОтбораЗаполнены = Ложь;
//            НаборЗаписей = РегистрыСведений.ЭКОМ_ЦепочкиДокументовПоставщика.СоздатьНаборЗаписей(); 
 
//            СтруктураОтбора = Новый Структура;
//            СтруктураОтбора.Вставить("Заказ"    , ДокументЗаказа);
//            СтруктураОтбора.Вставить("Накладная", ДокументРеализации);
//            Для каждого Данные Из СтруктураОтбора Цикл
//                Если ЗначениеЗаполнено(Данные.Значение) Тогда
//                    НаборЗаписей.Отбор[Данные.Ключ].Установить(Данные.Значение);
//                    ДанныеОтбораЗаполнены = Истина;
//                КонецЕсли;
//            КонецЦикла;
 
//            // Выполним блокировку данных
//            ЭКОМ_ПодпискаСобытий.ВыполнитьБлокировкуНабораЗаписей(НаборЗаписей.Отбор, "ЭКОМ_ЦепочкиДокументовПоставщика");
//            Если ДанныеОтбораЗаполнены Тогда
//                НаборЗаписей.Прочитать();
//                // Если существует документ в регистре
//                Для Каждого НоваяЗапись Из НаборЗаписей Цикл
 
//                    ЭКОМ_ПодпискаСобытий.СформироватьЗаписьВРегистр(НоваяЗапись, ДанныеИзмерений, ДанныеРесурсов);    
 
//                КонецЦикла;
 
//                НаборЗаписей.Записать();
 
//            КонецЕсли;                
//        КонецЕсли;
//    КонецЦикла;        
//КонецЕсли;
