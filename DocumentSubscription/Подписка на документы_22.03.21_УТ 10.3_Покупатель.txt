ТипДокументаЗаказа = "ДокументСсылка.ЗаказПоставщику";
ТипДокументаПоступления = "ДокументСсылка.ПоступлениеТоваровУслуг";
ТипДокументаСчетФактуры = "ДокументСсылка.СчетФактураПолученный";

ИмяОрганизации = "Организация";
ИмяКонтрагента = "Контрагент";
ИмяТочкиДоставки = "Склад";
ИмяДатаПоставки = "ДатаПоступления";
НомерВходящегоДокумента = "НомерВходящегоДокумента";
ДатаВходящегоДокумента = "ДатаВходящегоДокумента";
ИмяЗаказа1С = "ЗаказПоставщику";

// Заказ поставщику
Если ТипЗнч(Источник.Ссылка) = Тип(ТипДокументаЗаказа) Тогда
    
    ВыборкаУчастниковВЭДО = КонтрагентУчаствуетВЭДО(Источник[ИмяОрганизации], Источник[ИмяКонтрагента]);
    Если НЕ ВыборкаУчастниковВЭДО.Количество() = 0 Тогда
        
        ВыборкаУчастниковВЭДО.Следующий();
        
        НаборЗаписей = РегистрыСведений.ЭКОМ_ЦепочкиДокументовПокупателя.СоздатьНаборЗаписей();
        НаборЗаписей.Отбор.Заказ.Установить(Источник.Ссылка); // поле проиндексировано
        
        ДанныеИзмерений = Новый Структура;
        ДанныеИзмерений.Вставить("Заказ", Источник.Ссылка);
        ДанныеИзмерений.Вставить("ORDERDATE", Источник.Дата);
        ДанныеИзмерений.Вставить("ORDERNUMBER", Источник.Номер);
        ДанныеИзмерений.Вставить("Организация", Источник[ИмяОрганизации]);
        ДанныеИзмерений.Вставить("Контрагент", Источник[ИмяКонтрагента]);
        ДанныеИзмерений.Вставить("ТочкаДоставки", Источник[ИмяТочкиДоставки]);
        
        ДанныеРесурсов = Новый Структура;
        ДанныеРесурсов.Вставить("xmlОрганизация", ВыборкаУчастниковВЭДО.GLN_Организация);
        ДанныеРесурсов.Вставить("xmlКонтрагент", ВыборкаУчастниковВЭДО.GLN_Контрагент);
        ДанныеРесурсов.Вставить("xmlТочкаДоставки", ВыборкаУчастниковВЭДО.GLN_ТочкаДоставки);
        ДанныеРесурсов.Вставить("ДатаПоставки", Источник[ИмяДатаПоставки]);
        ДанныеРесурсов.Вставить("КоличествоЗаказ", Источник.Товары.Итог("Количество"));
        ДанныеРесурсов.Вставить("СуммаЗаказ", Источник.Товары.Итог("Сумма"));
        
        // Выполним блокировку данных
        ЭКОМ_ПодпискаСобытий.ВыполнитьБлокировкуНабораЗаписей(НаборЗаписей.Отбор, "ЭКОМ_ЦепочкиДокументовПокупателя");
        
        НаборЗаписей.Прочитать();
        Если НаборЗаписей.Количество() = 0 Тогда
            // Записываем документ в первый раз
            ЭКОМ_ПодпискаСобытий.СформироватьЗаписьВРегистр(НаборЗаписей.Добавить(), ДанныеИзмерений, ДанныеРесурсов); // записываем данные в регистр если они заполнены
            
        Иначе
            // Если существует документ в регистре
            Для Каждого НоваяЗапись Из НаборЗаписей Цикл
                ЭКОМ_ПодпискаСобытий.СформироватьЗаписьВРегистр(НоваяЗапись, ДанныеИзмерений, ДанныеРесурсов); // записываем данные в регистр если они заполнены
            КонецЦикла;
            
        КонецЕсли;
        
        НаборЗаписей.Записать();
        
    КонецЕсли;
    
КонецЕсли;