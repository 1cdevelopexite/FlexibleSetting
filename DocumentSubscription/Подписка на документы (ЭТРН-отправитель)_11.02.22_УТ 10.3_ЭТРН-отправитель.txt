//УТ 10.3
ТипДокументаРеализации  = "ДокументСсылка.РеализацияТоваровУслуг";

	ИмяЗаказа1С          = "Сделка";
	ИмяОрганизации		 = "Организация";
	ИмяКонтрагента		 = "Контрагент";
	ИмяТочкиДоставки	 = "Грузополучатель";
	НомерЗаказа1С        = "НомерВходящегоДокументаЭлектронногоОбмена";
	ДатаЗаказа1С         = "ДатаВходящегоДокументаЭлектронногоОбмена";
	НомерЭТРН            = "Номер";
	ДатаЭТРН             = "Дата";      
	ИмяПеревозчика       = "Грузоотправитель";


Если ТипЗнч(Источник.Ссылка) = Тип(ТипДокументаРеализации) Тогда
	    
	Выборка = КонтрагентУчаствуетВЭДО(Источник[ИмяОрганизации], Источник[ИмяКонтрагента]);
	Если НЕ Выборка.Количество() = 0 Тогда
		НаборЗаписей = РегистрыСведений.ЭКОМ_ЦепочкиДокументовЭТРН.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Накладная.Установить(Источник.Ссылка);
		
		//Выполним блокировку данных
		ЭКОМ_ПодпискаСобытий.ВыполнитьБлокировкуНабораЗаписей(НаборЗаписей.Отбор, "ЭКОМ_ЦепочкиДокументовЭТРН");
		НаборЗаписей.Прочитать();
		СчетФактура = Неопределено;	
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ
				|	РеализацияТоваровУслуг.Ссылка КАК Реализация,
				|	СчетФактураВыданный.Ссылка КАК СчетФактура
				|ИЗ
				|	Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
				|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный.ДокументыОснования КАК СчетФактураВыданныйДокументыОснования
				|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный КАК СчетФактураВыданный
				|			ПО (СчетФактураВыданный.Ссылка = СчетФактураВыданныйДокументыОснования.Ссылка)
				|		ПО (РеализацияТоваровУслуг.Ссылка = СчетФактураВыданныйДокументыОснования.ДокументОснование)
				|ГДЕ
				|	РеализацияТоваровУслуг.Ссылка = &Ссылка";
		
		Запрос.УстановитьПараметр("Ссылка", Источник.Ссылка);		
		РезультатЗапроса = Запрос.Выполнить();				
		Если НЕ РезультатЗапроса.Пустой() Тогда
			ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
		    ВыборкаДетальныеЗаписи.Следующий();
			СчетФактура = ВыборкаДетальныеЗаписи.СчетФактура;
		КонецЕсли;
		 
		// Если существует документ в регистре 
		Для Каждого НоваяЗапись Из НаборЗаписей Цикл
			НоваяЗапись.Перевозчик             = Источник[ИмяПеревозчика];
			НоваяЗапись.СчетФактура            = СчетФактура;
			НоваяЗапись.Заказ                  = Источник[ИмяЗаказа1С];
			НоваяЗапись.КоличествоГрузовыхМест = Источник.Товары.Итог("Количество");
			НоваяЗапись.ДатаЭТРН               = Источник[ДатаЭТРН];
		КонецЦикла;	
		
		// Записываем документ в первый раз
		Если НаборЗаписей.Количество() = 0 Тогда
			
			НоваяЗапись = НаборЗаписей.Добавить();
			НоваяЗапись.Организация        = Источник[ИмяОрганизации];
			НоваяЗапись.Контрагент         = Источник[ИмяКонтрагента];
			НоваяЗапись.ДатаЭТРН           = Источник[ДатаЭТРН];
			НоваяЗапись.НомерЭТРН          = Источник[НомерЭТРН];
			НоваяЗапись.Накладная = Источник.Ссылка;
			
			НоваяЗапись.СчетФактура            = СчетФактура;
			НоваяЗапись.Заказ                  = Источник[ИмяЗаказа1С];
			НоваяЗапись.Перевозчик             = Источник[ИмяПеревозчика];
			НоваяЗапись.КоличествоГрузовыхМест = Источник.Товары.Итог("Количество");
		КонецЕсли;
		
		НаборЗаписей.Записать();		
		
		//НаборЗаписейТИ = РегистрыСведений.ЭКОМ_ТранспортнаяИнформация.СоздатьНаборЗаписей();
		//НаборЗаписейТИ.Отбор.Документ.Установить(Источник.Ссылка);
		//
		//// Выполним блокировку данных
		//ЭКОМ_ПодпискаСобытий.ВыполнитьБлокировкуНабораЗаписей(НаборЗаписейТИ.Отбор, "ЭКОМ_ТранспортнаяИнформация");		
		//НаборЗаписейТИ.Прочитать();
		//		
		//Запрос = Новый Запрос;
		//Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
		//		|	ЗаданиеНаПеревозкуРаспоряжения.Ссылка КАК Ссылка
		//		|ИЗ
		//		|	Документ.ЗаданиеНаПеревозку.Распоряжения КАК ЗаданиеНаПеревозкуРаспоряжения
		//		|ГДЕ
		//		|	ЗаданиеНаПеревозкуРаспоряжения.Распоряжение = &Распоряжение";
		//
		//Запрос.УстановитьПараметр("Распоряжение", Источник.Ссылка);
		//		
		//НомерТТН = ЭКОМ_ОбщегоНазначения.ЭКОМ_ПолучитьНомерНаПечать(Источник.Ссылка);
		//Данные = Новый Структура;
		//Данные.Вставить("Перевозчик", Источник[ИмяПеревозчика]);
		//Данные.Вставить("НомерРейса", НомерТТН);
		//Данные.Вставить("НомерТТН", НомерТТН);
		//		
		//// Если существует документ в регистре 
		//Для Каждого НоваяЗапись Из НаборЗаписейТИ Цикл
		//	
		//	Для каждого Эл Из Данные Цикл
		//		Если ЗначениеЗаполнено(Эл.Значение) Тогда
		//			НоваяЗапись[Эл.Ключ] = Эл.Значение;		 
		//		КонецЕсли;
		//	КонецЦикла;
		//	
		//КонецЦикла;	
		//
		//// Записываем документ в первый раз
		//Если НаборЗаписейТИ.Количество() = 0 Тогда
		//	
		//	НоваяЗапись = НаборЗаписейТИ.Добавить();
		//	НоваяЗапись.Документ   = Источник.Ссылка;
		//	
		//	Для каждого Эл Из Данные Цикл
		//		Если ЗначениеЗаполнено(Эл.Значение) Тогда
		//			НоваяЗапись[Эл.Ключ] = Эл.Значение;		 
		//		КонецЕсли;
		//	КонецЦикла;
		//	
		//КонецЕсли;
		//
		//НаборЗаписейТИ.Записать();
		
	КонецЕсли;
	
КонецЕсли;

