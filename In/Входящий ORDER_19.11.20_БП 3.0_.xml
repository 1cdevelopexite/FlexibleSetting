<ValueTree xmlns="http://v8.1c.ru/8.1/data/core" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="ValueTree">
	<column>
		<Name xsi:type="xs:string">Использовать</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">ТипТранзакции</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Служебные</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">СлужебныеТекст</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Сохранение</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Загрузка</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Кнопка</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">КоллекцияТЧ</Name>
		<ValueType/>
	</column>
	<row>
		<Value xsi:type="xs:boolean">true</Value>
		<Value xsi:type="xs:string">Входящий ORDER</Value>
		<Value xsi:type="xs:string">ПерезаписыватьРеализациюКогдаПриходитКорректировочныйORDER = Ложь;

Если Приемник.xmlВалюта = "RUB" Тогда
	Валюта = Справочники.Валюты.НайтиПоКоду(643);
ИначеЕсли Приемник.xmlВалюта = "KZT" Тогда
	Валюта = Справочники.Валюты.НайтиПоКоду(398);
ИначеЕсли Приемник.xmlВалюта = "BYR" Тогда
	Валюта = Справочники.Валюты.НайтиПоКоду(974);
ИначеЕсли Приемник.xmlВалюта = "UAH" Тогда
	Валюта = Справочники.Валюты.НайтиПоКоду(980);
ИначеЕсли Приемник.xmlВалюта = "MDL" Тогда
	Валюта = Справочники.Валюты.НайтиПоКоду(498);
ИначеЕсли Приемник.xmlВалюта = "EUR" Тогда
	Валюта = Справочники.Валюты.НайтиПоКоду(978);
ИначеЕсли Приемник.xmlВалюта = "USD" Тогда
	Валюта = Справочники.Валюты.НайтиПоКоду(840);
Иначе
	Валюта = Справочники.Валюты.НайтиПоКоду(643);
КонецЕсли;

Приемник.Валюта = Валюта;

Приемник.Ответственный = ПользователиКлиентСервер.ТекущийПользователь();

//// Расчет ТЧ Товары
ФорматУПД = м_ПолучитьФорматКонтрагента(Приемник.Контрагент);
ИспользоватьОбратныйПорядокРасчетаСумм = НуженОбратныйРасчетСумм(ФорматУПД);

Для Каждого СтрокаТовары Из Приемник.ТЧ_Товары Цикл	
	
	Если ЗначениеЗаполнено(СтрокаТовары.ЦенаСНДС) 
		И ЗначениеЗаполнено(СтрокаТовары.СтавкаНДС) Тогда
		
		СтавкаНДС = СтрокаТовары.СтавкаНДС;
		СтруктураРасчета = РасчетСумм(СтрокаТовары.ЦенаСНДС, СтрокаТовары.СтавкаНДС, Истина, СтрокаТовары.КоличествоЗаказанное, 
		ИспользоватьОбратныйПорядокРасчетаСумм);
		
	ИначеЕсли ЗначениеЗаполнено(СтрокаТовары.Цена)  
		И ЗначениеЗаполнено(СтрокаТовары.СтавкаНДС) Тогда
		
		СтавкаНДС = СтрокаТовары.СтавкаНДС;
		СтруктураРасчета = РасчетСумм(СтрокаТовары.Цена, СтрокаТовары.СтавкаНДС, Ложь, СтрокаТовары.КоличествоЗаказанное, 
		ИспользоватьОбратныйПорядокРасчетаСумм);																								
		
	ИначеЕсли ЗначениеЗаполнено(СтрокаТовары.Цена)
		И ЗначениеЗаполнено(СтрокаТовары.ЦенаСНДС)
		И НЕ ЗначениеЗаполнено(СтрокаТовары.СтавкаНДС) Тогда
		
		СтавкаНДС = Окр(( (СтрокаТовары.ЦенаСНДС / СтрокаТовары.Цена) - 1 ) * 100, 0);
		СтруктураРасчета = РасчетСумм(СтрокаТовары.Цена, СтавкаНДС, Ложь, СтрокаТовары.КоличествоЗаказанное, 
		ИспользоватьОбратныйПорядокРасчетаСумм);			
		
	ИначеЕсли ЗначениеЗаполнено(СтрокаТовары.Цена) 
		И НЕ ЗначениеЗаполнено(СтрокаТовары.СтавкаНДС) Тогда	
		
		СтавкаНДС = СтавкаНДСЧислом(Перечисления.СтавкиНДС.СтавкаНДС(СтрокаТовары.Номенклатура.ВидСтавкиНДС, ТекущаяДата()));
		СтруктураРасчета = РасчетСумм(СтрокаТовары.Цена, СтавкаНДС, Ложь, СтрокаТовары.КоличествоЗаказанное, 
		ИспользоватьОбратныйПорядокРасчетаСумм);
		
	ИначеЕсли ЗначениеЗаполнено(СтрокаТовары.ЦенаСНДС) 
		И НЕ ЗначениеЗаполнено(СтрокаТовары.СтавкаНДС) Тогда	
		
		СтавкаНДС = СтавкаНДСЧислом(Перечисления.СтавкиНДС.СтавкаНДС(СтрокаТовары.Номенклатура.ВидСтавкиНДС, ТекущаяДата()));
		СтруктураРасчета = РасчетСумм(СтрокаТовары.ЦенаСНДС, СтавкаНДС, Истина, СтрокаТовары.КоличествоЗаказанное, 
		ИспользоватьОбратныйПорядокРасчетаСумм);		
	КонецЕсли;
	
	СтрокаТовары.Цена = СтруктураРасчета.ЦенаБезНДС;
	СтрокаТовары.ЦенаСНДС = СтруктураРасчета.ЦенаСНДС;
	СтрокаТовары.СтавкаНДС = СтавкаНДС;
	СтрокаТовары.Сумма = СтруктураРасчета.СуммаБезНДС;
	СтрокаТовары.Сумма_с_НДС = СтруктураРасчета.СуммаСНДС;
	СтрокаТовары.СуммаНДС = СтруктураРасчета.СуммаНДС;
	
КонецЦикла;

Приемник.СуммаДокументаВсего = Приемник.ТЧ_Товары.Итог("Сумма_с_НДС");
Приемник.СуммаНДСВсего = Приемник.ТЧ_Товары.Итог("СуммаНДС");
///////////////

Если Приемник.ТипДокумента = "R" Тогда
	Приемник.Комментарий = "Заказ обновлен!";
ИначеЕсли Приемник.ТипДокумента = "D" Тогда
	Приемник.Комментарий = "Заказ отменен!";	
КонецЕсли;

Приемник.Записать();

Если ПерезаписыватьРеализациюКогдаПриходитКорректировочныйORDER Тогда

	// Проверим, есть ли исходящий DESADV
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ЭКОМ_ЦепочкиДокументовПоставщика.Статус_DESADV КАК Статус_DESADV,
	|	ЭКОМ_ЦепочкиДокументовПоставщика.Статус_DESSCC КАК Статус_DESSCC,
	|	ЭКОМ_ЦепочкиДокументовПоставщика.Накладная КАК РТУ
	|ИЗ
	|	РегистрСведений.ЭКОМ_ЦепочкиДокументовПоставщика КАК ЭКОМ_ЦепочкиДокументовПоставщика
	|ГДЕ
	|	ЭКОМ_ЦепочкиДокументовПоставщика.ORDER = &amp;ORDER";
		
	Запрос.УстановитьПараметр("ORDER", Приемник.Ссылка);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ДесадвОтправлен = Ложь;
	РеализацияУжеЕсть = Ложь;
	
	Если НЕ РезультатЗапроса.Пустой() Тогда
			
		Выборка = РезультатЗапроса.Выбрать();
		Выборка.Следующий();
		Если Выборка.Статус_DESADV ИЛИ  Выборка.Статус_DESSCC Тогда
			ДесадвОтправлен = Истина; 
		КонецЕсли;
		Реализация = Выборка.РТУ;
		Если ЗначениеЗаполнено(Реализация) Тогда
		    РеализацияУжеЕсть = Истина;
		КонецЕсли;
		
	КонецЕсли;
	
	Если РеализацияУжеЕсть И НЕ ДесадвОтправлен Тогда
		//Перезапишем реализацию
		
		РеализацияОбъект = Реализация.ПолучитьОбъект();
		РеализацияОбъект.Дата = Приемник.ДатаПоставки;
		Для Каждого СтрокаORDER Из Приемник.ТЧ_Товары Цикл
			
			СтрокаРеализации = РеализацияОбъект.Товары.Найти(СтрокаORDER.Номенклатура, "Номенклатура");
			СтрокаРеализации.Количество = СтрокаORDER.КоличествоЗаказанное;
			СтрокаРеализации.Цена = СтрокаORDER.ЦенаСНДС;
			СтрокаРеализации.Сумма = СтрокаORDER.Сумма_с_НДС; 	
			СтрокаРеализации.СуммаНДС = СтрокаORDER.СуммаНДС;
			
		КонецЦикла; 
		
		РеализацияОбъект.Комментарий = "Заказ №" + Приемник.ЗаказНомер + " от " + Формат(Приемник.ЗаказДата, "ДФ='dd.MM.yyyy'") + ". Документ обновлен.";		
		
		РеализацияОбъект.Записать(РежимЗаписиДокумента.Запись);
		
	КонецЕсли;
	
КонецЕсли;

///////////////
Приемник.Записать(РежимЗаписиДокумента.Проведение);

// Регистрация ORDER в цепочке документов поставщика

НаборЗаписей = РегистрыСведений.ЭКОМ_ЦепочкиДокументовПоставщика.СоздатьНаборЗаписей();
НаборЗаписей.Отбор.ORDERDATE.Установить(Приемник.ЗаказДата);
НаборЗаписей.Отбор.ORDERNUMBER.Установить(Приемник.ЗаказНомер);
НаборЗаписей.Отбор.ORDER.Установить(Приемник.Ссылка);

НаборЗаписей.Прочитать();

// Если существует документ в регистре
Для Каждого НоваяЗапись Из НаборЗаписей Цикл
	НоваяЗапись.ДатаПоставки  = Приемник.ДатаПоставки;
	НоваяЗапись.Организация   = Приемник.Организация;
	НоваяЗапись.Контрагент    = Приемник.Контрагент;
	НоваяЗапись.ТочкаДоставки = Приемник.ТочкаДоставки;
	
	НоваяЗапись.КоличествоORDER = Приемник.ТЧ_Товары.Итог("КоличествоЗаказанное");
	НоваяЗапись.СуммаORDER = Приемник.ТЧ_Товары.Итог("Сумма_с_НДС");
КонецЦикла;	

// Записываем документ в первый раз
Если НаборЗаписей.Количество() = 0 Тогда
	НоваяЗапись = НаборЗаписей.Добавить();
	НоваяЗапись.ORDERDATE   = Приемник.ЗаказДата;
	НоваяЗапись.ORDERNUMBER = Приемник.ЗаказНомер;
	НоваяЗапись.ORDER       = Приемник.Ссылка;
	
	НоваяЗапись.xmlОрганизация   = Приемник.xmlОрганизация;
	НоваяЗапись.xmlКонтрагент    = Приемник.xmlКонтрагент;
	НоваяЗапись.xmlТочкаДоставки = Приемник.xmlТочкаДоставки;
	НоваяЗапись.ДатаПоставки     = Приемник.ДатаПоставки;
	НоваяЗапись.Организация      = Приемник.Организация;
	НоваяЗапись.Контрагент       = Приемник.Контрагент;
	НоваяЗапись.ТочкаДоставки    = Приемник.ТочкаДоставки;
	НоваяЗапись.КоличествоORDER  = Приемник.ТЧ_Товары.Итог("КоличествоЗаказанное");
	НоваяЗапись.СуммаORDER       = Приемник.ТЧ_Товары.Итог("Сумма_с_НДС");
КонецЕсли;

НаборЗаписей.Записать();
</Value>
		<Value xsi:type="xs:string"/>
		<Value xsi:type="xs:decimal">0</Value>
		<Value xsi:type="xs:decimal">0</Value>
		<Value xsi:type="xs:string">Заказы покупателей (ORDER)</Value>
		<Value xsi:type="ValueListType">
			<valueType/>
			<lastId xsi:type="xs:decimal">-1</lastId>
		</Value>
	</row>
</ValueTree>