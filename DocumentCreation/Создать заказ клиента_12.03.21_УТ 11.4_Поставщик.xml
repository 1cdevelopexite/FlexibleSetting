<ValueTree xmlns="http://v8.1c.ru/8.1/data/core" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="ValueTree">
	<column>
		<Name xsi:type="xs:string">Использовать</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Кнопка</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Источник</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Приемник</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Служебные</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Формула</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">СлужебныеТекст</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Сохранение</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Загрузка</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">КолонкаИсточника</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">КоллекцияТЧ</Name>
		<ValueType/>
	</column>
	<row>
		<Value xsi:type="xs:boolean">true</Value>
		<Value xsi:type="xs:string">Создать заказ клиента</Value>
		<Value xsi:type="xs:string">ЭКОМ Документы</Value>
		<Value xsi:type="xs:string">Заказ клиента</Value>
		<Value xsi:type="xs:string">// Получение общих для всех документов значений.
Если КэшированныеЗначения 	= Неопределено Тогда
	КэшированныеЗначения 	= ОбработкаТабличнойЧастиКлиентСервер.ПолучитьСтруктуруКэшируемыеЗначения();
КонецЕсли;

ПроводитьЗаказ 				= Неопределено;
Если НЕ КэшированныеЗначения.Свойство("ПроводитьЗаказ", ПроводитьЗаказ) Тогда
	ПроводитьЗаказ 			= Настройка_Параметр_Прочитать("ЭКОМ_СоздаватьДокументЗаказ1СПроведенным");
КонецЕсли;

ЗагружатьТекущейДатой 		= Неопределено;
Если НЕ КэшированныеЗначения.Свойство("ЗагружатьТекущейДатой", ЗагружатьТекущейДатой) Тогда
	ЗагружатьТекущейДатой 	= Настройка_Параметр_Прочитать("ЭКОМ_ЗаказыЗагружатьТекущейДатой");
КонецЕсли;

КолонкиДокумента 			= Неопределено;
Если НЕ КэшированныеЗначения.Свойство("КолонкиДокумента", КолонкиДокумента) Тогда
	КолонкиДокумента 		= Новый Соответствие;
	Для Каждого Колонка Из  Документы.ЗаказКлиента.ПустаяСсылка().Товары.ВыгрузитьКолонки().Колонки Цикл
	    КолонкиДокумента.Вставить(Колонка.Имя, Колонка.ТипЗначения.ПривестиЗначение());
	КонецЦикла;
КонецЕсли;
// Получение функциональных опций.
ИспользоватьРасширенныеВозможностиЗаказаКлиента 	= Неопределено;
Если НЕ КэшированныеЗначения.Свойство("ИспользоватьРасширенныеВозможностиЗаказаКлиента", ИспользоватьРасширенныеВозможностиЗаказаКлиента) Тогда
	ИспользоватьРасширенныеВозможностиЗаказаКлиента = ПолучитьФункциональнуюОпцию("ИспользоватьРасширенныеВозможностиЗаказаКлиента");
КонецЕсли;

ИспользоватьАвтоматическиеСкидкиВПродажах 			= Неопределено;
Если НЕ КэшированныеЗначения.Свойство("ИспользоватьАвтоматическиеСкидкиВПродажах", ИспользоватьАвтоматическиеСкидкиВПродажах) Тогда
	ИспользоватьАвтоматическиеСкидкиВПродажах 		= ПолучитьФункциональнуюОпцию("ИспользоватьАвтоматическиеСкидкиВПродажах");
КонецЕсли;

ИспользоватьСоглашенияСКлиентами 					= Неопределено;
Если НЕ КэшированныеЗначения.Свойство("ИспользоватьСоглашенияСКлиентами", ИспользоватьСоглашенияСКлиентами) Тогда
	ИспользоватьСоглашенияСКлиентами 				= ПолучитьФункциональнуюОпцию("ИспользоватьСоглашенияСКлиентами");
КонецЕсли;

ИспользоватьУправлениеДоставкой 					= Неопределено;
Если НЕ КэшированныеЗначения.Свойство("ИспользоватьУправлениеДоставкой", ИспользоватьУправлениеДоставкой) Тогда
	ИспользоватьУправлениеДоставкой 				= ПолучитьФункциональнуюОпцию("ИспользоватьУправлениеДоставкой");
КонецЕсли;

УстановитьПривилегированныйРежим(Истина);
// Основной запрос для заполнения шапки документа.
Запрос = Новый Запрос;
Запрос.Текст = 
    "ВЫБРАТЬ
    |    ЭКОМ_Документы.Ссылка КАК Ссылка,
    |    ЭКОМ_Документы.Ссылка.Представление КАК ИсточникПредставление,
    |    ВЫРАЗИТЬ(ЭКОМ_Документы.Документ1С КАК Документ.ЗаказКлиента) КАК Заказ,
    |    Приоритеты.Ссылка КАК Приоритет,
    |    ЭКОМ_Документы.Дата КАК Дата,
    |    ЭКОМ_Документы.ТочкаДоставки КАК Партнер,
    |    ЭКОМ_Документы.ТочкаДоставки.Представление КАК ПартнерПредставление,
    |    ЭКОМ_Документы.Контрагент КАК Контрагент,
    |    ЭКОМ_Документы.Организация КАК Организация,
    |    ЭКОМ_Документы.ЗаказНомер КАК НомерПоДаннымКлиента,
    |    ЭКОМ_Документы.ЗаказДата КАК ДатаПоДаннымКлиента,
    |    ИСТИНА КАК НеОтгружатьЧастями,
    |    ЭКОМ_Документы.ДатаПоставки КАК ЖелаемаяДатаОтгрузки,
    |    ЭКОМ_Документы.ДатаПоставки КАК ДатаОтгрузки,
    |    ЗНАЧЕНИЕ(Перечисление.СпособыДоставки.Самовывоз) КАК СпособДоставки,
    |    ИСТИНА КАК СкидкиРассчитаны,
    |    ЭКОМ_Документы.ФайлНомер КАК ФайлНомер,
    |    ЭКОМ_Документы.ФайлДата КАК ФайлДата,
    |    ЕСТЬNULL(ЭКОМ_GLN.Контрагент_ЦеныИз1С, ЛОЖЬ) КАК ЦеныИз1С
    |ИЗ
    |    Справочник.Приоритеты КАК Приоритеты,
    |    Документ.ЭКОМ_Документы КАК ЭКОМ_Документы
    |        ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЭКОМ_GLN КАК ЭКОМ_GLN
    |        ПО ЭКОМ_Документы.Контрагент = ЭКОМ_GLN.Объект
    |ГДЕ
    |    Приоритеты.Наименование = ""Средний""
    |    И ЭКОМ_Документы.Ссылка В(&amp;Источник)";
Запрос.УстановитьПараметр("Источник", Источник);
РезультатЗапроса = Запрос.Выполнить().Выгрузить();

// Получение данных табличной части Товары.
Запрос = Новый Запрос;
Запрос.Текст = 
    "ВЫБРАТЬ
    |	ЭКОМ_ДокументыТЧ_Товары.Ссылка КАК Ссылка,
    |	ЭКОМ_ДокументыТЧ_Товары.Номенклатура КАК Номенклатура,
    |	ЭКОМ_ДокументыТЧ_Товары.КоличествоПоставляемое КАК КоличествоУпаковок,
    |	ЭКОМ_ДокументыТЧ_Товары.Цена КАК Цена,
    |	ЭКОМ_ДокументыТЧ_Товары.ЦенаСНДС КАК ЦенаСНДС,
    |	ВЫБОР
    |		КОГДА ЭКОМ_ДокументыТЧ_Товары.ЕдиницаИзмерения = ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПУстаяСсылка)
    |			ТОГДА ЭКОМ_ДокументыТЧ_Товары.ЕдиницаИзмерения
    |		КОГДА ЭКОМ_ДокументыТЧ_Товары.ЕдиницаИзмерения.ЕдиницаИзмерения = ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПУстаяСсылка)
    |			ТОГДА ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПУстаяСсылка)
    |		ИНАЧЕ ЭКОМ_ДокументыТЧ_Товары.ЕдиницаИзмерения
    |	КОНЕЦ КАК Упаковка,
    |	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК Характеристика,
    |	ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка) КАК Склад,
    |	ЛОЖЬ КАК Отменено
    |ИЗ
    |	Документ.ЭКОМ_Документы.ТЧ_Товары КАК ЭКОМ_ДокументыТЧ_Товары
    |ГДЕ
    |	ЭКОМ_ДокументыТЧ_Товары.Ссылка В(&amp;Источник)";
Запрос.УстановитьПараметр("Источник", Источник);
РезультатЗапросаТЧТовары = Запрос.Выполнить().Выгрузить();

Если ИспользоватьУправлениеДоставкой Тогда
    Запрос = Новый Запрос(
        "ВЫБРАТЬ
        |    КонтактнаяИнформация.Ссылка КАК Ссылка,
        |    КонтактнаяИнформация.Вид.Представление КАК Вид,
        |    КонтактнаяИнформация.Представление КАК АдресДоставки,
        |    КонтактнаяИнформация.ЗначенияПолей КАК АдресДоставкиЗначенияПолей
        |ИЗ
        |    Справочник.Партнеры.КонтактнаяИнформация КАК КонтактнаяИнформация
        |ГДЕ
        |    КонтактнаяИнформация.Ссылка В(&amp;Партнер)
        |    И КонтактнаяИнформация.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.Адрес)");

    Запрос.УстановитьПараметр("Партнер", РезультатЗапроса.ВыгрузитьКолонку("Партнер"));
    АдресаПолучателяИзКонтактнойИнформации = Запрос.Выполнить().Выгрузить();
КонецЕсли;

УстановитьПривилегированныйРежим(Ложь);

Для Каждого Запись Из РезультатЗапроса Цикл
    // Берем ранее созданный документ, если он заполнен в Документ1С Эком документа.
    Приемник = ?(ЗначениеЗаполнено(Запись.Заказ), Запись.Заказ.ПолучитьОбъект(), Приемник);
    // Очистка реквизитов документа перед заполнением.
    ЗаполнитьЗначенияСвойств(Приемник, Документы.ЗаказКлиента.СоздатьДокумент());
    // Автозаполнение документа.
    ЗаполнениеСвойствПоСтатистикеСервер.ЗаполнитьСвойстваОбъекта(Приемник, Неопределено);
    // Заполнение реквизитов из запроса.
    ЗаполнитьЗначенияСвойств(Приемник, Запись);
    // Заполнение соглашения и этапов графика оплаты.
    Если ИспользоватьСоглашенияСКлиентами Тогда
        Приемник.ЗаполнитьУсловияПродажПоУмолчанию();
        Если НЕ ЗначениеЗаполнено(Приемник.Соглашение) Тогда
            ТекстОшибки = НСтр("ru = 'Не найдено соглашение для Партнера &lt;%Партнер%&gt;. Докуент не создан'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
            ТекстОшибки = СтрЗаменить(ТекстОшибки, "%Партнер%", Запись.ПартнерПредставление);
            ЗаписатьЛогСобытий(ЛогСобытий, ТекстОшибки);
            Продолжить;
        КонецЕсли;
    КонецЕсли;
    // Заполнение адреса доставки.
    Если ИспользоватьУправлениеДоставкой Тогда
        АдресПолучателя = АдресаПолучателяИзКонтактнойИнформации.НайтиСтроки(Новый Структура("Ссылка, Вид", Приемник.Партнер, "Адрес доставки"));
        ЗаполнитьЗначенияСвойств(Приемник, ?(АдресПолучателя.Количество() &gt; 0, АдресПолучателя.Получить(0), Новый Структура));
    КонецЕсли;
    // Установка статуса.
    Если ИспользоватьРасширенныеВозможностиЗаказаКлиента Тогда
        Приемник.Статус = Перечисления.СтатусыЗаказовКлиентов.КОбеспечению;
    Иначе
        Приемник.Статус = Перечисления.СтатусыЗаказовКлиентов.НеСогласован;
    КонецЕсли;
    // Корректировка реквизитов.
    Приемник.Дата = ?(ЗагружатьТекущейДатой = Истина, ТекущаяДата(), Приемник.Дата);
    Приемник.ДатаОтгрузки = ?(ЗначениеЗаполнено(Приемник.ДатаОтгрузки) И Приемник.ДатаОтгрузки &lt; НачалоДня(Приемник.Дата),
        НачалоДня(Приемник.Дата), Приемник.ДатаОтгрузки);
    Приемник.ЖелаемаяДатаОтгрузки = ?(ЗначениеЗаполнено(Приемник.ЖелаемаяДатаОтгрузки) И Приемник.ЖелаемаяДатаОтгрузки &lt; НачалоДня(Приемник.Дата),
        НачалоДня(Приемник.Дата), Приемник.ЖелаемаяДатаОтгрузки);
    Приемник.Менеджер = Пользователи.ТекущийПользователь();
    Приемник.Комментарий = ?(ЗначениеЗаполнено(Запись.НомерПоДаннымКлиента), "Заказ № " + Запись.НомерПоДаннымКлиента, "");
    Приемник.Комментарий = Приемник.Комментарий
        + ?(ЗначениеЗаполнено(Приемник.Комментарий) И ЗначениеЗаполнено(Запись.ДатаПоДаннымКлиента), 
        " от " + Формат(Запись.ДатаПоДаннымКлиента, "ДФ=dd.MM.yyyy"), "");
    // Заполнение ответственных лиц.
    ОтветственныеЛица = ОтветственныеЛицаСервер.ПолучитьОтветственныеЛицаОрганизации(Приемник.Организация, КонецДня(Приемник.Дата));
    Приемник.Руководитель         = ОтветственныеЛица.РуководительСсылка;
    Приемник.ГлавныйБухгалтер     = ОтветственныеЛица.ГлавныйБухгалтерСсылка;
    // Заполнение Товаров.
    Приемник.Товары.Очистить();
    СтруктураПересчетаСуммы = ОбработкаТабличнойЧастиКлиентСервер.ПараметрыПересчетаСуммыНДСВСтрокеТЧ(Приемник);
    ПараметрыУказанияСерий = Новый ФиксированнаяСтруктура(НоменклатураСервер.ПараметрыУказанияСерий(Приемник, Документы.ЗаказКлиента));
    ВариантыОбеспечения = ПродажиСервер.ВариантыОбеспеченияПоУмолчанию(Приемник.Соглашение, Приемник.Статус, ПредопределенноеЗначение("Перечисление.ВариантыОбеспечения.Отгрузить"));

    Для Каждого Строка Из РезультатЗапросаТЧТовары.НайтиСтроки(Новый Структура("Ссылка", Запись.Ссылка)) Цикл

        ДанныеДляЗаполнения = Новый Структура;
        Для Каждого Колонка Из КолонкиДокумента Цикл
            ДанныеДляЗаполнения.Вставить(Колонка.Ключ, Колонка.Значение);
        КонецЦикла;

        // Заполнение данных строки.
        ЗаполнитьЗначенияСвойств(ДанныеДляЗаполнения, Строка, "Номенклатура, КоличествоУпаковок, Упаковка");
        ДанныеДляЗаполнения.Склад = Приемник.Склад;
        // Заполнение реквизитов строки методами конфигурации (пока без цен и сумм).
        СтруктураДействий = Новый Структура;
        //СтруктураДействий.Вставить("ПроверитьЗаполнитьУпаковкуПоВладельцу", ДанныеДляЗаполнения.Упаковка);
		СтруктураДействий.Вставить("ПересчитатьКоличествоЕдиниц");
		Если ИспользоватьСоглашенияСКлиентами И ЗначениеЗаполнено(Приемник.Соглашение) Тогда
		    СтруктураДействий.Вставить("ЗаполнитьУсловияПродаж", ОбработкаТабличнойЧастиКлиентСервер.ПолучитьСтруктуруЗаполненияУсловийПродажВСтрокеТЧ(Приемник));
		Иначе
		    СтруктураДействий.Вставить("ЗаполнитьЦенуПродажи", ОбработкаТабличнойЧастиКлиентСервер.ПолучитьСтруктуруЗаполненияЦеныВСтрокеТЧ(Приемник));
		КонецЕсли;
		СтруктураДействий.Вставить("ЗаполнитьСтавкуНДС", Новый Структура("НалогообложениеНДС, Дата, ПоДатеОтгрузки", Приемник.НалогообложениеНДС, Приемник.Дата, Истина));
		СтруктураДействий.Вставить("ЗаполнитьСтавкуНДСВозвратнойТары", Приемник.ВернутьМногооборотнуюТару);
		СтруктураДействий.Вставить("ЗаполнитьСодержание", ОбработкаТабличнойЧастиКлиентСервер.ПолучитьСтруктуруЗаполненияСодержанияУслугиВСтрокеТЧ(Приемник, Ложь));
		СтруктураДействий.Вставить("ПроверитьСериюРассчитатьСтатус", Новый Структура("Склад, ПараметрыУказанияСерий", ДанныеДляЗаполнения.Склад, ПараметрыУказанияСерий));
		ПараметрыДействия = ОбеспечениеКлиентСервер.ПараметрыДействияПроверитьЗаполнитьОбеспечение(ВариантыОбеспечения, Приемник.ЖелаемаяДатаОтгрузки);
		СтруктураДействий.Вставить("ПроверитьЗаполнитьОбеспечениеВДокументеПродажи", ПараметрыДействия);
		СтруктураДействий.Вставить("ЗаполнитьНоменклатуруПартнераПоНоменклатуре", Приемник.Партнер);
        ОбработкаТабличнойЧастиСервер.ОбработатьСтрокуТЧ(ДанныеДляЗаполнения, СтруктураДействий, КэшированныеЗначения);

        // Заполнение цены.
        Цена = 0;
        Если Приемник.ЦенаВключаетНДС И ЗначениеЗаполнено(Строка.ЦенаСНДС) Тогда
            Цена = Строка.ЦенаСНДС;
        ИначеЕсли НЕ Приемник.ЦенаВключаетНДС И ЗначениеЗаполнено(Строка.Цена) Тогда
            Цена = Строка.Цена;
        ИначеЕсли Приемник.ЦенаВключаетНДС И ЗначениеЗаполнено(Строка.Цена) Тогда
            Цена  = Окр((Строка.Цена * (100 + СтавкаНДСЧислом(ДанныеДляЗаполнения.СтавкаНДС))) / 100 , 4);
        ИначеЕсли НЕ Приемник.ЦенаВключаетНДС И ЗначениеЗаполнено(Строка.ЦенаСНДС) Тогда
            Цена = Окр((Строка.ЦенаСНДС * 100) / (100 + СтавкаНДСЧислом(ДанныеДляЗаполнения.СтавкаНДС)) , 4);
        КонецЕсли;
        ДанныеДляЗаполнения.Цена = Цена;
        // Заполнение сумм методами конфигурации.
        СтруктураДействий = Новый Структура;
        СтруктураДействий.Вставить("ПересчитатьСуммуНДС", СтруктураПересчетаСуммы);
        СтруктураДействий.Вставить("ПересчитатьСуммуСНДС", СтруктураПересчетаСуммы);
        СтруктураДействий.Вставить("ПересчитатьСумму");
        СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомРучнойСкидки", Новый Структура("Очищать", Истина));
        СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомАвтоматическойСкидки", Новый Структура("Очищать", Истина));
        ОбработкаТабличнойЧастиСервер.ОбработатьСтрокуТЧ(ДанныеДляЗаполнения, СтруктураДействий, КэшированныеЗначения);
        // Перенос данных в строку ТЧ Товары.
        ЗаполнитьЗначенияСвойств(Приемник.Товары.Добавить(), ДанныеДляЗаполнения);

    КонецЦикла;

    // Получение цен из 1С для контрагентов, у котороых стоит такая настройка.
    Если Запись.ЦеныИз1С Тогда
        Запрос = Новый Запрос;
        Запрос.Текст = 
            "ВЫБРАТЬ
            |    Основание.НомерСтроки КАК НомерСтроки,
            |    Основание.Номенклатура КАК Номенклатура,
            |    Основание.Характеристика КАК Характеристика,
            |    Основание.Упаковка КАК Упаковка,
            |    Основание.ВидЦены КАК ВидЦены
            |ПОМЕСТИТЬ вт
            |ИЗ
            |    &amp;Основание КАК Основание
            |;
            |
            |////////////////////////////////////////////////////////////////////////////////
            |ВЫБРАТЬ
            |    вт.НомерСтроки КАК НомерСтроки,
            |    вт.Номенклатура КАК Номенклатура,
            |    вт.Характеристика КАК Характеристика,
            |    вт.Упаковка КАК Упаковка,
            |    ЦеныНоменклатурыСрезПоследних.Цена КАК Цена,
            |    ЦеныНоменклатурыСрезПоследних.ВидЦены.ЦенаВключаетНДС КАК ЦенаВключаетНДС
            |ПОМЕСТИТЬ втЦеныНоменклатуры
            |ИЗ
            |    вт КАК вт
            |        ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&amp;ДатаЗаказа, ) КАК ЦеныНоменклатурыСрезПоследних
            |        ПО вт.Номенклатура = ЦеныНоменклатурыСрезПоследних.Номенклатура
            |            И вт.Характеристика = ЦеныНоменклатурыСрезПоследних.Характеристика
            |            И вт.Упаковка = ЦеныНоменклатурыСрезПоследних.Упаковка
            |            И вт.ВидЦены = ЦеныНоменклатурыСрезПоследних.ВидЦены
            |;
            |
            |////////////////////////////////////////////////////////////////////////////////
            |ВЫБРАТЬ
            |    вт.Номенклатура КАК Номенклатура,
            |    вт.Характеристика КАК Характеристика,
            |    вт.Упаковка КАК Упаковка,
            |    СоглашенияСКлиентамиТовары.Цена КАК Цена,
            |    СоглашенияСКлиентамиТовары.Ссылка.ЦенаВключаетНДС КАК ЦенаВключаетНДС
            |ПОМЕСТИТЬ втСоглашения
            |ИЗ
            |    вт КАК вт
            |        ЛЕВОЕ СОЕДИНЕНИЕ Справочник.СоглашенияСКлиентами.Товары КАК СоглашенияСКлиентамиТовары
            |        ПО вт.Номенклатура = СоглашенияСКлиентамиТовары.Номенклатура
            |            И вт.Характеристика = СоглашенияСКлиентамиТовары.Характеристика
            |            И вт.Упаковка = СоглашенияСКлиентамиТовары.Упаковка
            |ГДЕ
            |    СоглашенияСКлиентамиТовары.Ссылка = &amp;СоглашенияСКлиентами
            |;
            |
            |////////////////////////////////////////////////////////////////////////////////
            |ВЫБРАТЬ
            |    втЦеныНоменклатуры.НомерСтроки КАК НомерСтроки,
            |    втЦеныНоменклатуры.Номенклатура КАК Номенклатура,
            |    втЦеныНоменклатуры.Характеристика КАК Характеристика,
            |    втЦеныНоменклатуры.Упаковка КАК Упаковка,
            |    ЕСТЬNULL(втСоглашения.Цена, втЦеныНоменклатуры.Цена) КАК Цена,
            |    ЕСТЬNULL(втСоглашения.ЦенаВключаетНДС, втЦеныНоменклатуры.ЦенаВключаетНДС) КАК ЦенаВключаетНДС
            |ИЗ
            |    втЦеныНоменклатуры КАК втЦеныНоменклатуры
            |        ЛЕВОЕ СОЕДИНЕНИЕ втСоглашения КАК втСоглашения
            |        ПО втЦеныНоменклатуры.Номенклатура = втСоглашения.Номенклатура
            |            И втЦеныНоменклатуры.Характеристика = втСоглашения.Характеристика
            |            И втЦеныНоменклатуры.Упаковка = втСоглашения.Упаковка";

        Запрос.УстановитьПараметр("Основание", Приемник.Товары);
        Запрос.УстановитьПараметр("ДатаЗаказа", Приемник.Дата);
        Запрос.УстановитьПараметр("СоглашенияСКлиентами", Приемник.Соглашение);

        РезультатЗапросаЦены = Запрос.Выполнить();

        ВыборкаДетальныеЗаписи = РезультатЗапросаЦены.Выбрать();

        Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
            Если ЗначениеЗаполнено(ВыборкаДетальныеЗаписи.Цена)
                И ТипЗнч(ВыборкаДетальныеЗаписи.ЦенаВключаетНДС) = Тип("Булево") Тогда
                Строка = Приемник.Товары.Найти(ВыборкаДетальныеЗаписи.НомерСтроки, "НомерСтроки");
                Если Строка = Неопределено Тогда
                    Продолжить;
                КонецЕсли;
                Цена = 0;
                Если Приемник.ЦенаВключаетНДС И ВыборкаДетальныеЗаписи.ЦенаВключаетНДС Тогда
                    Цена = ВыборкаДетальныеЗаписи.Цена;
                ИначеЕсли НЕ Приемник.ЦенаВключаетНДС И НЕ ВыборкаДетальныеЗаписи.ЦенаВключаетНДС Тогда
                    Цена = ВыборкаДетальныеЗаписи.Цена;
                ИначеЕсли Приемник.ЦенаВключаетНДС И НЕ ВыборкаДетальныеЗаписи.ЦенаВключаетНДС Тогда
                    Цена  = Окр((ВыборкаДетальныеЗаписи.Цена * (100 + СтавкаНДСЧислом(Строка.СтавкаНДС))) / 100 , 4);
                ИначеЕсли НЕ Приемник.ЦенаВключаетНДС И ВыборкаДетальныеЗаписи.ЦенаВключаетНДС Тогда
                    Цена = Окр((ВыборкаДетальныеЗаписи.Цена * 100) / (100 + СтавкаНДСЧислом(Строка.СтавкаНДС)) , 4);
                КонецЕсли;
                Если НЕ Цена = 0 Тогда
                    Строка.Цена = Цена;
                    // Заполнение сумм методами конфигурации.
                    СтруктураДействий = Новый Структура;
                    СтруктураДействий.Вставить("ПересчитатьСуммуНДС", СтруктураПересчетаСуммы);
                    СтруктураДействий.Вставить("ПересчитатьСуммуСНДС", СтруктураПересчетаСуммы);
                    СтруктураДействий.Вставить("ПересчитатьСумму");
                    СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомРучнойСкидки", Новый Структура("Очищать", Истина));
                    СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомАвтоматическойСкидки", Новый Структура("Очищать", Истина));
                    ОбработкаТабличнойЧастиСервер.ОбработатьСтрокуТЧ(Строка, СтруктураДействий, КэшированныеЗначения);
                КонецЕсли;
            КонецЕсли;
        КонецЦикла;
    КонецЕсли;

    // Заполнение порядка оплаты.
    Если Не ЗначениеЗаполнено(Приемник.ПорядокОплаты) Тогда
        ВалютаОплаты            = ДенежныеСредстваСервер.ПолучитьВалютуОплаты(Приемник.ФормаОплаты, Приемник.БанковскийСчет, Приемник.Касса);
        Приемник.ПорядокОплаты     = Перечисления.ПорядокОплатыПоСоглашениям.ПолучитьПорядокОплатыПоУмолчанию(Приемник.Валюта, Приемник.НалогообложениеНДС, ВалютаОплаты);
    КонецЕсли;
    // Заполнение этапов графика оплаты.
    Приемник.ЗаполнитьЭтапыГрафикаОплаты();
    // Проверка и запись документов.
    ОшибокНеОбнаружено = Приемник.ПроверитьЗаполнение();
    Если ОшибокНеОбнаружено Тогда
        НачатьТранзакцию();
        Попытка
            Приемник.Записать(?(ПроводитьЗаказ, РежимЗаписиДокумента.Проведение, РежимЗаписиДокумента.Запись));
        Исключение
            ТекстОшибки = НСтр("ru = 'Ошибка %РежимЗаписиДокумента% документа на основе входящего документа № %ФайлНомер% от %ФайлДата%. '" + ОписаниеОшибки(), ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
            ТекстОшибки = СтрЗаменить(ТекстОшибки, "%РежимЗаписиДокумента%", ?(ПроводитьЗаказ, "проведения", "записи"));
            ТекстОшибки = СтрЗаменить(ТекстОшибки, "%ФайлНомер%", Запись.ФайлНомер);
            ТекстОшибки = СтрЗаменить(ТекстОшибки, "%ФайлДата%", Формат(Запись.ФайлДата, "ДФ=dd.MM.yyyy"));
            ЗаписатьЛогСобытий(ЛогСобытий, ТекстОшибки);
            ОтменитьТранзакцию();
            Продолжить;
        КонецПопытки;
        // Запись ссылки в ЭКОМ документ.
        Попытка
            ИсточникОбъект = Источник.ПолучитьОбъект();
            ИсточникОбъект.Документ1С = Приемник.Ссылка;
			ИсточникОбъект.НеВыполнятьКодПриЗаписи = Истина;
            ИсточникОбъект.Записать();
        Исключение
            ТекстОшибки = НСтр("ru = 'Ошибка записи ссылки на созданный документ в %Источник%. '" + ОписаниеОшибки(), ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
            ТекстОшибки = СтрЗаменить(ТекстОшибки, "%Источник%", Запись.ИсточникПредставление);
            ЗаписатьЛогСобытий(ЛогСобытий, ТекстОшибки);
            ОтменитьТранзакцию();
            Продолжить;
        КонецПопытки;
        ЗафиксироватьТранзакцию();
    КонецЕсли;
КонецЦикла;</Value>
		<Value xsi:type="xs:string"/>
		<Value xsi:type="xs:string"/>
		<Value xsi:type="xs:decimal">0</Value>
		<Value xsi:type="xs:decimal">0</Value>
		<Value xsi:type="xs:string">ЭКОМ_Документ_ORDER</Value>
		<Value xsi:type="ValueListType">
			<valueType/>
			<lastId xsi:type="xs:decimal">3</lastId>
			<item>
				<value xsi:type="xs:string">ИмяКнопки</value>
				<presentation>Создать заказ клиента</presentation>
				<checkState>1</checkState>
				<id xsi:type="xs:decimal">0</id>
			</item>
			<item>
				<value xsi:type="xs:string">Покупатель</value>
				<id xsi:type="xs:decimal">1</id>
			</item>
			<item>
				<value xsi:type="xs:string">Поставщик</value>
				<checkState>1</checkState>
				<id xsi:type="xs:decimal">2</id>
			</item>
			<item>
				<value xsi:type="xs:string">ЭТРН</value>
				<id xsi:type="xs:decimal">3</id>
			</item>
		</Value>
	</row>
</ValueTree>