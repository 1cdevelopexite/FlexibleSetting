<ValueTree xmlns="http://v8.1c.ru/8.1/data/core" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="ValueTree">
	<column>
		<Name xsi:type="xs:string">Использовать</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Кнопка</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">КолонкаИсточника</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Источник</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Приемник</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">СлужебныеТекст</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Сохранение</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Загрузка</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Формула</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Служебные</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">КоллекцияТЧ</Name>
		<ValueType/>
	</column>
	<row>
		<Value xsi:type="xs:boolean">true</Value>
		<Value xsi:type="xs:string">Создать корректировку реализации</Value>
		<Value xsi:type="xs:string">ДокументРеализации</Value>
		<Value xsi:type="xs:string">РеализацияТоваровУслуг</Value>
		<Value xsi:type="xs:string">Корректировка реализации</Value>
		<Value xsi:type="xs:string"/>
		<Value xsi:nil="true"/>
		<Value xsi:nil="true"/>
		<Value xsi:type="xs:string"/>
		<Value xsi:type="xs:string">Если КэшированныеЗначения = Неопределено Тогда
	КэшированныеЗначения = новый Структура;
КонецЕсли;
// Получение общих для всех документов значений.
ПроводитьРеализацию			= Неопределено;
Если НЕ КэшированныеЗначения.Свойство("ПроводитьРеализацию", ПроводитьРеализацию) Тогда
	ПроводитьРеализацию		= Настройка_Параметр_Прочитать("ЭКОМ_СоздаватьДокументРеализация1СПроведенным");
	КэшированныеЗначения.Вставить("ПроводитьРеализацию", ПроводитьРеализацию);
КонецЕсли;

ИсточникМассив     = Новый Массив;
Если НЕ ТипЗнч(Источник) = Тип("Массив") Тогда
    ИсточникМассив.Добавить(Источник);
    Источник     = ИсточникМассив;
КонецЕсли;

Запрос = Новый Запрос;
Запрос.Текст = 
    "ВЫБРАТЬ
    |    ЭКОМ_ЦепочкиДокументовПоставщика.RECADV КАК RECADV,
    |    ЭКОМ_ЦепочкиДокументовПоставщика.Накладная КАК РеализацияСсылка,
    |    ЭКОМ_ЦепочкиДокументовПоставщика.ORDERNUMBER КАК ORDERNUMBER,
    |    ЭКОМ_ЦепочкиДокументовПоставщика.ORDERDATE КАК ORDERDATE,
    |    ЭКОМ_ЦепочкиДокументовПоставщика.RECADV.ФайлНомер КАК RECADVФайлНомер,
    |    ЭКОМ_ЦепочкиДокументовПоставщика.RECADV.ФайлДата КАК RECADVФайлДата
    |ИЗ
    |    РегистрСведений.ЭКОМ_ЦепочкиДокументовПоставщика КАК ЭКОМ_ЦепочкиДокументовПоставщика
    |ГДЕ
    |    ЭКОМ_ЦепочкиДокументовПоставщика.Накладная В(&amp;Документ)";

Запрос.УстановитьПараметр("Документ", Источник);

РезультатЗапроса = Запрос.Выполнить();

Запись = РезультатЗапроса.Выбрать();

Пока Запись.Следующий() Цикл

    Приемник = Документы.КорректировкаРеализации.СоздатьДокумент();
    Приемник.Заполнить(Запись.РеализацияСсылка);
    Приемник.Дата = ТекущаяДатаСеанса();
    Приемник.Комментарий = "Заказ № %ORDERNUMBER% от %ORDERDATE%";
    Приемник.Комментарий = СтрЗаменить(Приемник.Комментарий, "%ORDERNUMBER%", Запись.ORDERNUMBER);
    Приемник.Комментарий = СтрЗаменить(Приемник.Комментарий, "%ORDERDATE%", Формат(Запись.ORDERDATE, "ДФ=dd.MM.yyyy"));
	Приемник.ВидОперации = ПредопределенноеЗначение("Перечисление.ВидыОперацийИсправленияПоступленияРеализации.СогласованноеИзменение");
    // Перезаполняем ТЧ Товары.
	СкорректированныеСтроки = Новый Массив;
    Для Каждого СтрокаRECADV Из Запись.RECADV.ТЧ_Товары Цикл
        СтрокаКорректировки = Приемник.Товары.Найти(СтрокаRECADV.Номенклатура, "Номенклатура");
        Если СтрокаКорректировки = Неопределено Тогда
            Продолжить;
        КонецЕсли;
        СтрокаКорректировки.Количество = СтрокаRECADV.КоличествоПринятое;
		
		Если ТипЗнч(СтрокаКорректировки.Номенклатура) = Тип("СправочникСсылка.Номенклатура") Тогда // изменен реквизит Количество
			ОбработкаТабличныхЧастей.РассчитатьКоличествоМестТабЧасти(СтрокаКорректировки, ЭтотОбъект);
		КонецЕсли;
		СтрокаКорректировки.ОтражатьТоварныйУчет = Истина;
		
		СтрокаКорректировки.Сумма = СтрокаКорректировки.Цена * СтрокаКорректировки.Количество;
		СтрокаКорректировки.СуммаНДС = 
			УчетНДС.РассчитатьСуммуНДС(
				СтрокаКорректировки.Сумма,
				Приемник.УчитыватьНДС,
				Приемник.СуммаВключаетНДС,
				УчетНДС.ПолучитьСтавкуНДС(
					СтрокаКорректировки.СтавкаНДС));
		СкорректированныеСтроки.Добавить(СтрокаКорректировки);			
    КонецЦикла;
    // Удаление отсутствующих в RECADV строк.
    СтрокиДляУдаления = Новый Массив;

    Для Каждого СтрокаКорректировки Из Приемник.Товары Цикл
        Если СкорректированныеСтроки.Найти(СтрокаКорректировки) = Неопределено
            ИЛИ СтрокаКорректировки.Количество = 0 Тогда
            СтрокиДляУдаления.Добавить(СтрокаКорректировки);
        КонецЕсли;
    КонецЦикла;

    Для Каждого СтрокаКорректировки Из СтрокиДляУдаления Цикл
        ИндексСтрокаКорректировки = Приемник.Товары.Индекс(СтрокаКорректировки);
        Если ИндексСтрокаКорректировки &gt;= 0 Тогда
            Приемник.Товары.Удалить(ИндексСтрокаКорректировки);
        КонецЕсли;
    КонецЦикла;

    ОшибокНеОбнаружено = Приемник.ПроверитьЗаполнение();
    Если ОшибокНеОбнаружено Тогда
        Попытка
            Приемник.Записать(?(ПроводитьРеализацию, РежимЗаписиДокумента.Проведение, РежимЗаписиДокумента.Запись));
        Исключение
            Ошибка = ОписаниеОшибки();
            ТекстОшибки = НСтр("ru = 'Ошибка %РежимЗаписиДокумента% документа на основе входящего документа № %ФайлНомер% от %ФайлДата%. '" + ОписаниеОшибки());
            ТекстОшибки = СтрЗаменить(ТекстОшибки, "%РежимЗаписиДокумента%", ?(ПроводитьРеализацию, "проведения", "записи"));
            ТекстОшибки = СтрЗаменить(ТекстОшибки, "%ФайлНомер%", Запись.ФайлНомер);
            ТекстОшибки = СтрЗаменить(ТекстОшибки, "%ФайлДата%", Формат(Запись.ФайлДата, "ДФ=dd.MM.yyyy"));
            ЗаписатьЛогСобытий(ЛогСобытий, ТекстОшибки);
            Продолжить;
        КонецПопытки;
    КонецЕсли;
КонецЦикла;</Value>
		<Value xsi:type="ValueListType">
			<valueType/>
			<lastId xsi:type="xs:decimal">3</lastId>
			<item>
				<value xsi:type="xs:string">ИмяКнопки</value>
				<presentation>Создать корректировку реализации товаров</presentation>
				<checkState>1</checkState>
				<id xsi:type="xs:decimal">0</id>
			</item>
			<item>
				<value xsi:type="xs:string">Покупатель</value>
				<id xsi:type="xs:decimal">1</id>
			</item>
			<item>
				<value xsi:type="xs:string">Поставщик</value>
				<checkState>1</checkState>
				<id xsi:type="xs:decimal">2</id>
			</item>
			<item>
				<value xsi:type="xs:string">ЭТРН</value>
				<id xsi:type="xs:decimal">3</id>
			</item>
		</Value>
	</row>
</ValueTree>