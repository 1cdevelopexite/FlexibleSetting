<ValueTree xmlns="http://v8.1c.ru/8.1/data/core" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="ValueTree">
	<column>
		<Name xsi:type="xs:string">Использовать</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Кнопка</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Источник</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Приемник</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Служебные</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Формула</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">СлужебныеТекст</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Сохранение</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Загрузка</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">КолонкаИсточника</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">КоллекцияТЧ</Name>
		<ValueType/>
	</column>
	<row>
		<Value xsi:type="xs:boolean">true</Value>
		<Value xsi:type="xs:string">Создать корректировку реализации</Value>
		<Value xsi:type="xs:string">Реализация товаров и услуг</Value>
		<Value xsi:type="xs:string">КорректировкаРеализации</Value>
		<Value xsi:type="xs:string">ИспользоватьКорректировкиРеализаций = ПолучитьФункциональнуюОпцию("ИспользоватьКорректировкиРеализаций");
Если ИспользоватьКорректировкиРеализаций = Истина Тогда
    ПроводитьРеализацию = Настройка_Параметр_Прочитать("ЭКОМ_СоздаватьДокументРеализация1СПроведенным");

    ИсточникМассив     = Новый Массив;
    Если НЕ ТипЗнч(Источник) = Тип("Массив") Тогда
        ИсточникМассив.Добавить(Источник);
        Источник     = ИсточникМассив;
    КонецЕсли;

    Запрос = Новый Запрос;
    Запрос.Текст = 
        "ВЫБРАТЬ
        |    ЭКОМ_ЦепочкиДокументовПоставщика.RECADV КАК RECADV,
        |    ЭКОМ_ЦепочкиДокументовПоставщика.Накладная КАК РеализацияСсылка,
        |    ЭКОМ_ЦепочкиДокументовПоставщика.ORDERNUMBER КАК ORDERNUMBER,
        |    ЭКОМ_ЦепочкиДокументовПоставщика.ORDERDATE КАК ORDERDATE,
        |    ЭКОМ_ЦепочкиДокументовПоставщика.RECADV.ФайлНомер КАК RECADVФайлНомер,
        |    ЭКОМ_ЦепочкиДокументовПоставщика.RECADV.ФайлДата КАК RECADVФайлДата,
        |    ЭКОМ_ЦепочкиДокументовПоставщика.Накладная.Основание КАК НакладнаяОснование,
        |    ЭКОМ_ЦепочкиДокументовПоставщика.Накладная.ОснованиеНомер КАК НакладнаяОснованиеНомер,
        |    ЭКОМ_ЦепочкиДокументовПоставщика.Накладная.ОснованиеДата КАК НакладнаяОснованиеДата
        |ИЗ
        |    РегистрСведений.ЭКОМ_ЦепочкиДокументовПоставщика КАК ЭКОМ_ЦепочкиДокументовПоставщика
        |ГДЕ
        |    ЭКОМ_ЦепочкиДокументовПоставщика.Накладная В(&amp;Документ)";

    Запрос.УстановитьПараметр("Документ", Источник);

    РезультатЗапроса = Запрос.Выполнить();

    Запись = РезультатЗапроса.Выбрать();
    КэшированныеЗначения = ОбработкаТабличнойЧастиКлиентСервер.ПолучитьСтруктуруКэшируемыеЗначения();

    Пока Запись.Следующий() Цикл

        Приемник = Документы.КорректировкаРеализации.СоздатьДокумент();
        Приемник.Заполнить(Запись.РеализацияСсылка);
        Приемник.Дата = ТекущаяДатаСеанса();
        Приемник.Комментарий = "Заказ № %ORDERNUMBER% от %ORDERDATE%";
        Приемник.Комментарий = СтрЗаменить(Приемник.Комментарий, "%ORDERNUMBER%", Запись.ORDERNUMBER);
        Приемник.Комментарий = СтрЗаменить(Приемник.Комментарий, "%ORDERDATE%", Формат(Запись.ORDERDATE, "ДФ=dd.MM.yyyy"));
        Приемник.Основание = Запись.НакладнаяОснование;
        Приемник.ВидКорректировки = ПредопределенноеЗначение("Перечисление.ХозяйственныеОперации.КорректировкаПоСогласованиюСторон");
        Приемник.ОснованиеНомер = Запись.НакладнаяОснованиеНомер;
        Приемник.ОснованиеДата = Запись.НакладнаяОснованиеДата;
        // Перезаполняем ТЧ Товары.
        Для Каждого СтрокаRECADV Из Запись.RECADV.ТЧ_Товары Цикл
            СтрокаКорректировки = Приемник.Товары.Найти(СтрокаRECADV.Номенклатура, "Номенклатура");
            Если СтрокаКорректировки = Неопределено Тогда
                Продолжить;
            КонецЕсли;
            СтрокаКорректировки.КоличествоУпаковок = СтрокаRECADV.КоличествоПринятое;
			ОбработкаТабличнойЧастиКлиентСервер.ПересчитатьКоличествоЕдиницВСтрокеТЧ(СтрокаКорректировки, Новый Структура("ПересчитатьКоличествоЕдиниц", СтрокаКорректировки.Упаковка), КэшированныеЗначения);
            СтрокаКорректировки.Содержание = "Строка скорректирована RECADV"; // Временно для удаления удаленных в RECADV строк
            СтруктураПересчетаСуммы = ОбработкаТабличнойЧастиКлиентСервер.ПараметрыПересчетаСуммыНДСВСтрокеТЧ(Приемник);
            СтруктураДействий = Новый Структура;
            СтруктураДействий.Вставить("ПересчитатьКоличествоУпаковок");
            СтруктураДействий.Вставить("ПересчитатьСуммуНДС", СтруктураПересчетаСуммы);
            СтруктураДействий.Вставить("ПересчитатьСуммуСНДС", СтруктураПересчетаСуммы);
            СтруктураДействий.Вставить("ПересчитатьСумму", "КоличествоУпаковок");

            ОбработкаТабличнойЧастиСервер.ОбработатьСтрокуТЧ(СтрокаКорректировки, СтруктураДействий, КэшированныеЗначения);

        КонецЦикла;
        // Удаление отсутствующих в RECADV строк.
        СтрокиДляУдаления = Новый Массив;

        Для Каждого СтрокаКорректировки Из Приемник.Товары Цикл
            Если НЕ СтрокаКорректировки.Содержание = "Строка скорректирована RECADV"
                ИЛИ СтрокаКорректировки.Количество = 0 Тогда
                СтрокиДляУдаления.Добавить(СтрокаКорректировки);
            КонецЕсли;
            СтрокаКорректировки.Содержание = "";
        КонецЦикла;

        Для Каждого СтрокаКорректировки Из СтрокиДляУдаления Цикл
            ИндексСтрокаКорректировки = Приемник.Товары.Индекс(СтрокаКорректировки);
            Если ИндексСтрокаКорректировки &gt;= 0 Тогда
                Приемник.Товары.Удалить(ИндексСтрокаКорректировки);
            КонецЕсли;
        КонецЦикла;

        // Заполняем ТЧ расхождений.
        Если Не ЗначениеЗаполнено(Приемник.ДокументОснование) Тогда
            ТекстОшибки = НСтр("ru = 'Поле ""Документ основание"" не заполнено';
                |en = '""Base document"" is required'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
            ЗаписатьЛогСобытий(ЛогСобытий, ТекстОшибки);
            Продолжить;
        КонецЕсли;

        ОбщегоНазначенияУТ.ОкруглитьКоличествоШтучныхТоваров(Приемник);
        Документы.КорректировкаРеализации.ЗаполнитьРасхождения(Приемник);

        ПараметрыУказанияСерий = НоменклатураСервер.ПараметрыУказанияСерий(Приемник, Документы.КорректировкаРеализации);
        ПараметрыУказанияСерий.ИмяТЧТовары = "Расхождения";
        ПараметрыУказанияСерий.ИмяТЧСерии  = "Расхождения";
        НоменклатураСервер.ЗаполнитьСтатусыУказанияСерий(Приемник, ПараметрыУказанияСерий);
        ПараметрыУказанияСерий.ИмяТЧТовары = "Товары";
        ПараметрыУказанияСерий.ИмяТЧСерии  = "Товары";

        СтруктураДействий = Новый Структура;
        СтруктураДействий.Вставить("ПересчитатьКоличествоЕдиниц");
        ОбработкаТабличнойЧастиСервер.ОбработатьТЧ(Приемник.Расхождения, СтруктураДействий, КэшированныеЗначения);
        // Установка варианта отражения расхождений.
        Для Каждого СтрокаРасхождения Из Приемник.Расхождения Цикл
            СтрокаРасхождения.ВариантОтражения = ПредопределенноеЗначение("Перечисление.ВариантыОтраженияКорректировокРеализаций." + ?(СтрокаРасхождения.КоличествоУпаковок &gt; 0, "УвеличитьРеализациюУчестьПриИнвентаризации",  "УменьшитьРеализациюУчестьПриИнвентаризации"));
        КонецЦикла;

        ОшибокНеОбнаружено = Приемник.ПроверитьЗаполнение();
        Если ОшибокНеОбнаружено Тогда
            НачатьТранзакцию();
            Попытка
                Приемник.Записать(?(ПроводитьРеализацию, РежимЗаписиДокумента.Проведение, РежимЗаписиДокумента.Запись));
            Исключение
                Ошибка = ОписаниеОшибки();
                ТекстОшибки = НСтр("ru = 'Ошибка %РежимЗаписиДокумента% документа на основе входящего документа № %ФайлНомер% от %ФайлДата%. '" + ОписаниеОшибки(), ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
                ТекстОшибки = СтрЗаменить(ТекстОшибки, "%РежимЗаписиДокумента%", ?(ПроводитьРеализацию, "проведения", "записи"));
                ТекстОшибки = СтрЗаменить(ТекстОшибки, "%ФайлНомер%", Запись.ФайлНомер);
                ТекстОшибки = СтрЗаменить(ТекстОшибки, "%ФайлДата%", Формат(Запись.ФайлДата, "ДФ=dd.MM.yyyy"));
                ЗаписатьЛогСобытий(ЛогСобытий, ТекстОшибки);
                ОтменитьТранзакцию();
                Продолжить;
            КонецПопытки;
            ЗафиксироватьТранзакцию();
        КонецЕсли;
    КонецЦикла;
Иначе
    ТекстОшибки = НСтр("ru = 'В настройках программы отключена возможность создания корректировок реализации'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
    ЗаписатьЛогСобытий(ЛогСобытий, ТекстОшибки);
КонецЕсли;</Value>
		<Value xsi:type="xs:string"/>
		<Value xsi:type="xs:string"/>
		<Value xsi:type="xs:decimal">0</Value>
		<Value xsi:type="xs:decimal">0</Value>
		<Value xsi:type="xs:string">ДокументРеализации</Value>
		<Value xsi:type="ValueListType">
			<valueType/>
			<lastId xsi:type="xs:decimal">3</lastId>
			<item>
				<value xsi:type="xs:string">ИмяКнопки</value>
				<presentation>Создать корректировку реализации товаров</presentation>
				<checkState>1</checkState>
				<id xsi:type="xs:decimal">0</id>
			</item>
			<item>
				<value xsi:type="xs:string">Покупатель</value>
				<id xsi:type="xs:decimal">1</id>
			</item>
			<item>
				<value xsi:type="xs:string">Поставщик</value>
				<checkState>1</checkState>
				<id xsi:type="xs:decimal">2</id>
			</item>
			<item>
				<value xsi:type="xs:string">ЭТРН</value>
				<id xsi:type="xs:decimal">3</id>
			</item>
		</Value>
	</row>
</ValueTree>